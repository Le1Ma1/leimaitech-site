<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>LeiMai Pro 訂閱</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="/style.css" rel="stylesheet">
</head>
<body>
  <main class="container">
    <h1>LeiMai Pro 訂閱</h1>

    <section class="plan">
      <h2>Pro（月繳）</h2>
      <div class="badge badge-success">🎉 前 10 日免費</div>
      <p>第 11 天起每月自動扣款，扣款日依你的申辦日而定。</p>
      <p class="price">NT$199 / 月</p>
      <button id="btnMonth">立即訂閱（月繳）</button>
    </section>

    <section class="plan">
      <h2>Pro（年繳）</h2>
      <div class="badge badge-success">🎉 前 10 日免費</div>
      <p>第 11 天起每年自動扣款，扣款日依你的申辦日而定。</p>
      <p class="price">NT$1,999 / 年</p>
      <button id="btnYear">立即訂閱（年繳）</button>
    </section>

    <p class="note">說明：前 10 日免費為數位內容試用，首扣日將在試用期結束的隔日（UTC+8）。</p>
  </main>

  <script>
    async function postJSON(url, data) {
      return fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      }).then(r => r.json());
    }

    async function startSubscribe(period) {
      const userId = window.localStorage.getItem('userId') || 'test-user-' + Date.now();
      window.localStorage.setItem('userId', userId);

      // 1) 註冊（冪等）
      await postJSON('/api/register', {
        userId,
        displayName: 'WebUser',
        email: '',
        phone: ''
      });

      // 2) 建單（會計算 10 日免費與首扣日）
      const r = await postJSON('/api/subscribe', {
        userId,
        displayName: 'WebUser',
        email: '',
        plan: 'pro',
        period // 'month' | 'year'
      });

      if (!r || !r.order_no) {
        alert('建單失敗，請稍後再試');
        return;
      }

      // 3) 交給後端產生 NDNP 表單並自動送出
      location.href = `/pay?order_no=${r.order_no}`;
    }

    document.getElementById('btnMonth').addEventListener('click', () => startSubscribe('month'));
    document.getElementById('btnYear').addEventListener('click', () => startSubscribe('year'));
  </script>
</body>
</html>
